---
- name: get cloudformation info
  cloudformation_facts:
    stack_name: "{{ item.name }}"
  register: res

- set_fact:
    cfn_state: "{{ ansible_facts['cloudformation'][ item.name ]['stack_description']['stack_status'] }}"
  when: ansible_facts['cloudformation'][ item.name ] is defined

- name: remove a cloudformation stack
  cloudformation:
    stack_name: "{{ item.name }}"
    state: "absent"
  when: cfn_state is defined and cfn_state == "CREATE_FAILED"

- name: create a cloudformation stack
  cloudformation:
    stack_name: "{{ item.name }}"
    state: "{{ state }}"
    region: "{{ region }}"
    disable_rollback: true
    template: "cfn/template/ec2_win.yaml"
    template_parameters:
      TagEnv: "{{ env }}"
      TagOs: "{{ item.os }}"
      TagVerion: "{{ item.version }}"
    tags:
      Stack: "ansible-cloudformation"
